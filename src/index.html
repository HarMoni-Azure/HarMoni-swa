<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>건설현장 안전 관리 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --sidebar-width: 280px;
        }
        
        html, body {
            overflow-x: hidden;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: padding-right 0.3s ease;
        }
        
        /* 모달 열릴 때 스크롤바 너비만큼 padding 추가하여 레이아웃 시프트 방지 */
        body.modal-open {
            overflow: hidden;
        }
        
        * {
            box-sizing: border-box;
        }
        
        /* 사이드바 */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: #212529;
            color: white;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        /* 모바일에서 사이드바 숨김 */
        .sidebar.mobile-hidden {
            transform: translateX(-100%);
        }
        
        /* 사이드바 오버레이 (모바일용) */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        /* 메인 컨텐츠 */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        
        /* 햄버거 메뉴 버튼 (기본 숨김) */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .menu-toggle:hover {
            background: #0b5ed7;
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
            border-left: 4px solid;
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .worker-card {
            background: #2c3034;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #495057;
        }
        
        .worker-card:hover {
            background: #343a40;
            border-left-color: var(--primary-color);
        }
        
        .worker-card.active {
            border-left-color: var(--primary-color);
            background: #1a1d20;
        }
        
        .worker-card.warning {
            border-left-color: var(--warning-color);
        }
        
        .worker-card.danger {
            border-left-color: var(--danger-color);
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .chart-wrapper.small {
            height: 200px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-online {
            background: #d1f4e0;
            color: #0f5132;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #664d03;
        }
        
        .status-danger {
            background: #f8d7da;
            color: #842029;
        }
        
        .status-offline {
            background: #e2e3e5;
            color: #41464b;
        }
        
        .logo {
            font-size: 1.3rem;
            font-weight: 700;
            padding: 1.5rem;
            border-bottom: 1px solid #495057;
        }
        
        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            color: #adb5bd;
        }
        
        .nav-item:hover {
            background: #343a40;
            color: white;
            border-left-color: var(--primary-color);
        }
        
        .nav-item.active {
            background: #1a1d20;
            color: white;
            border-left-color: var(--primary-color);
        }
        
        .alert-item {
            padding: 1rem;
            border-left: 4px solid;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .alert-item:hover {
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            transform: translateX(3px);
        }
        
        .alert-item.critical {
            border-left-color: var(--danger-color);
            background: #f8d7da;
        }
        
        .alert-item.warning {
            border-left-color: var(--warning-color);
            background: #fff3cd;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .search-box {
            position: relative;
            margin: 1rem 1.5rem;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2.5rem;
            border: 1px solid #495057;
            border-radius: 6px;
            background: #343a40;
            color: white;
        }
        
        .search-box input::placeholder {
            color: #adb5bd;
        }
        
        .search-box i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
        }
        
        .fall-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .zone-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #e7f1ff;
            color: #084298;
        }
        
        /* 긴급 알림 모달 */
        .emergency-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .emergency-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .emergency-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.4s ease;
            margin: 0 auto;
        }
        
        .emergency-modal-header {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 1.5rem;
            border-radius: 16px 16px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .emergency-modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, #fff, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes scan {
            0% { 
                left: -100%;
            }
            100% { 
                left: 100%;
            }
        }
        
        .emergency-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1;
        }
        
        .emergency-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .emergency-modal-body {
            padding: 1.5rem;
        }
        
        .emergency-alert-item {
            background: #fff;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            animation: slideIn 0.3s ease;
        }
        
        .emergency-alert-item:hover {
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            transform: translateX(5px);
        }
        
        .emergency-alert-item.critical {
            background: #f8d7da;
            animation: alertPulse 2s infinite;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes alertPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
        }
        
        .severity-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .severity-critical {
            background: #dc3545;
            color: white;
        }
        
        .severity-warning {
            background: #ffc107;
            color: #000;
        }
        
        /* 작업자 상세 정보 모달 */
        .worker-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .worker-detail-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .worker-detail-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: zoomIn 0.3s ease;
            margin: 0 auto;
        }
        
        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .worker-detail-header {
            background: linear-gradient(135deg, #0d6efd, #0a58ca);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .header {
                padding: 1rem;
                margin-top: 3.5rem;
            }
            
            .header h2 {
                font-size: 1.3rem;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
            
            .stat-card {
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .emergency-modal-content {
                width: 95%;
            }
            
            .worker-detail-content {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- 햄버거 메뉴 버튼 (모바일) -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list fs-4"></i>
    </button>

    <!-- 사이드바 오버레이 (모바일) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- 사이드바 -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <i class="bi bi-building"></i> 안전관리 시스템
        </div>
        
        <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" id="workerSearch" placeholder="작업자 검색...">
        </div>
        
        <div class="nav-item active">
            <i class="bi bi-speedometer2"></i> 실시간 모니터링
        </div>
        <div class="nav-item">
            <i class="bi bi-exclamation-triangle"></i> 낙상 이력
        </div>
        <div class="nav-item">
            <i class="bi bi-people"></i> 작업자 관리
        </div>
        <div class="nav-item">
            <i class="bi bi-geo-alt"></i> 위치 추적
        </div>
        <div class="nav-item">
            <i class="bi bi-graph-up"></i> 안전 통계
        </div>
        <div class="nav-item">
            <i class="bi bi-gear"></i> 설정
        </div>
        
        <div style="padding: 1rem 1.5rem; margin-top: 1rem; border-top: 1px solid #495057;">
            <h6 class="text-muted mb-3" style="font-size: 0.85rem;">현장 작업자</h6>
            <div id="workerList"></div>
        </div>
    </div>

    <!-- 긴급 알림 모달 -->
    <div id="emergencyModal" class="emergency-modal">
        <div class="emergency-modal-content">
            <div class="emergency-modal-header">
                <button class="emergency-close" onclick="closeEmergencyModal()">×</button>
                <h3 class="mb-2">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    긴급 알림
                </h3>
                <p class="mb-0">즉시 대응이 필요한 상황</p>
            </div>
            <div class="emergency-modal-body" id="emergencyAlertList">
                <!-- 알림 목록이 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <!-- 작업자 상세 정보 모달 -->
    <div id="workerDetailModal" class="worker-detail-modal">
        <div class="worker-detail-content">
            <div class="worker-detail-header">
                <button class="emergency-close" onclick="closeWorkerDetailModal()">×</button>
                <h4 class="mb-0" id="workerDetailName">작업자 상세 정보</h4>
            </div>
            <div class="p-4" id="workerDetailBody">
                <!-- 상세 정보가 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content">
        <!-- 헤더 -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">건설현장 안전 관리 대시보드</h2>
                    <p class="text-muted mb-0" style="font-size: 1.1rem;">
                        <span id="currentDate"></span> | 
                        총 <span id="totalWorkers">10</span>명 |
                        <span class="text-success">정상 <span id="normalCount">7</span></span> |
                        <span class="text-warning">주의 <span id="warningCount">2</span></span> |
                        <span class="text-danger">위험 <span id="dangerCount">1</span></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- 주요 통계 -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="stat-card" style="border-left-color: var(--success-color);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small">현장 작업자</div>
                            <div class="metric-value text-success">
                                <span id="activeWorkers">10</span>
                            </div>
                            <small class="text-muted">온라인 디바이스</small>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-people-fill fs-4 text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="stat-card" style="border-left-color: var(--danger-color);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small">오늘 낙상 감지</div>
                            <div class="metric-value text-danger">
                                <span id="todayFalls">3</span>
                            </div>
                            <small class="text-danger">
                                <i class="bi bi-arrow-up"></i> 전일 대비 +1
                            </small>
                        </div>
                        <div class="bg-danger bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-activity fs-4 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="stat-card" style="border-left-color: var(--warning-color);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small">위험구역 접근</div>
                            <div class="metric-value text-warning">
                                <span id="dangerZone">5</span>
                            </div>
                            <small class="text-muted">최근 1시간</small>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-exclamation-triangle-fill fs-4 text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="stat-card" style="border-left-color: var(--info-color);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small">평균 작업시간</div>
                            <div class="metric-value text-info">
                                <span id="avgWorkTime">6.2</span><small class="fs-6">h</small>
                            </div>
                            <small class="text-success">
                                <i class="bi bi-check-circle"></i> 적정 수준
                            </small>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-clock-fill fs-4 text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 긴급 알림 및 작업자 정보 -->
        <div class="row align-items-stretch">
            <div class="col-12 col-xl-4 mb-4">
                <div class="card h-100 chart-container">
                    <h5 class="mb-3">
                        <i class="bi bi-bell-fill text-danger me-2"></i>긴급 알림
                    </h5>
                    <div id="alertsList" style="overflow-y: auto;"></div>
                </div>
            </div>

            <!-- 낙상 발생 위치 및 통계 -->
            <div class="col-12 col-xl-8 d-flex flex-column">
                <div class="card mb-4" style="flex:0.5">
                    <div class="chart-container mb-0">
                        <h5 class="mb-3">구역별 낙상 발생 현황</h5>
                        <div class="chart-wrapper">
                            <canvas id="fallZoneChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card mb-4" style="flex:0.5">
                    <div class="chart-container mb-0">
                        <h5 class="mb-3">시간대별 안전사고 발생</h5>
                        <div class="chart-wrapper">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 낙상 감지 데이터 -->
        <!-- <div class="row">
            <div class="col-xl-6 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3">실시간 가속도 변화 (낙상 감지)</h5>
                    <div class="chart-wrapper">
                        <canvas id="accelerationChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-xl-6 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3">자세 안정성 지표</h5>
                    <div class="chart-wrapper">
                        <canvas id="stabilityChart"></canvas>
                    </div>
                </div>
            </div>
        </div> -->

        <!-- 바이탈 데이터 -->
        <!-- <div class="row">
            <div class="col-xl-6 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3">심박수 모니터링</h5>
                    <div class="chart-wrapper">
                        <canvas id="heartRateChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-xl-6 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3">체온 모니터링 (열사병 예방)</h5>
                    <div class="chart-wrapper">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>
        </div> -->

        <!-- 낙상 발생 위치 및 통계 -->
        <!-- <div class="row">
            <div class="col-xl-6 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3">구역별 낙상 발생 현황</h5>
                    <div class="chart-wrapper">
                        <canvas id="fallZoneChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-xl-6 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3">시간대별 안전사고 발생</h5>
                    <div class="chart-wrapper">
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
            </div>
        </div> -->

        <!-- 작업자별 상태 테이블 -->
        <div class="chart-container">
            <h5 class="mb-3">작업자 현황</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>이름</th>
                            <th>직무</th>
                            <th>구역</th>
                            <th>심박수</th>
                            <th>체온</th>
                            <th>낙상위험도</th>
                            <th>작업시간</th>
                            <th>안전장비</th>
                            <th>상태</th>
                        </tr>
                    </thead>
                    <tbody id="workerTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 낙상 이력 -->
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="bi bi-clipboard-data text-danger me-2"></i>최근 낙상 이력
            </h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>시간</th>
                            <th>작업자</th>
                            <th>위치</th>
                            <th>가속도 (G)</th>
                            <th>낙상 유형</th>
                            <th>대응상태</th>
                        </tr>
                    </thead>
                    <tbody id="fallHistoryBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 전역 변수 및 데이터 구조
        // ============================================
        
        // 작업자 데이터
        const workers = [
            { id: 1, name: '김철수', age: 45, role: '철근공', zone: 'A동 3층', status: 'normal', deviceId: 'DEV-001', phone: '010-1234-5678' },
            { id: 2, name: '이영희', age: 62, role: '비계공', zone: 'B동 옥상', status: 'warning', deviceId: 'DEV-002', phone: '010-2345-6789' },
            { id: 3, name: '남준혁', age: 30, role: '용접공', zone: 'A동 2층', status: 'normal', deviceId: 'DEV-003', phone: '010-3456-7890' },
            { id: 4, name: '정수진', age: 55, role: '타일공', zone: 'C동 1층', status: 'danger', deviceId: 'DEV-004', phone: '010-4567-8901' },
            { id: 5, name: '최동욱', age: 41, role: '전기공', zone: 'B동 지하', status: 'normal', deviceId: 'DEV-005', phone: '010-5678-9012' },
            { id: 6, name: '강서연', age: 59, role: '배관공', zone: 'A동 4층', status: 'normal', deviceId: 'DEV-006', phone: '010-6789-0123' },
            { id: 7, name: '윤재현', age: 48, role: '도장공', zone: 'C동 3층', status: 'warning', deviceId: 'DEV-007', phone: '010-7890-1234' },
            { id: 8, name: '한미라', age: 52, role: '미장공', zone: 'B동 2층', status: 'normal', deviceId: 'DEV-008', phone: '010-8901-2345' },
            { id: 9, name: '김혁수', age: 27, role: '크레인 기사', zone: '외부', status: 'normal', deviceId: 'a3f652cf-a54b-4f19-945c-d25a8fc5ef77', phone: '010-9012-3456' },
            { id: 10, name: '장유진', age: 42, role: '안전관리자', zone: '전체', status: 'normal', deviceId: 'DEV-010', phone: '010-0123-4567' }
        ];

        // 긴급 알림 배열 (실시간 데이터가 추가될 저장소)
        let emergencyAlerts = [];

        let selectedWorkerId = 1;
        let charts = {};
        let dataIndex = 0;
        const maxDataPoints = 30;

        const chartData = {
            labels: [],
            acceleration: [],
            stability: [],
            heartRate: [],
            temperature: []
        };

        // ============================================
        // 반응형 사이드바 제어
        // ============================================
        
        /**
         * 사이드바 토글 함수 (모바일용)
         */
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // ============================================
        // 모달 제어 함수 (스크롤바 너비 보정)
        // ============================================
        
        /**
         * 스크롤바 너비 계산
         * @returns {number} 스크롤바 너비 (px)
         */
        function getScrollbarWidth() {
            return window.innerWidth - document.documentElement.clientWidth;
        }

        /**
         * 긴급 알림 모달 열기
         */
        function openEmergencyModal() {
            const modal = document.getElementById('emergencyModal');
            const scrollbarWidth = getScrollbarWidth();
            
            // 스크롤바 너비만큼 padding을 추가하여 레이아웃 시프트 방지
            if (scrollbarWidth > 0) {
                document.body.style.paddingRight = scrollbarWidth + 'px';
            }
            
            document.body.classList.add('modal-open');
            modal.classList.add('show');
            
            // 긴급 알림 목록 렌더링
            renderEmergencyAlerts();
        }

        /**
         * 긴급 알림 모달 닫기
         */
        function closeEmergencyModal() {
            const modal = document.getElementById('emergencyModal');
            
            // padding 제거
            document.body.style.paddingRight = '';
            document.body.classList.remove('modal-open');
            modal.classList.remove('show');
        }

        /**
         * 작업자 상세 모달 열기
         * @param {number} workerId - 작업자 ID
         */
        function openWorkerDetailModal(workerId) {
            const worker = workers.find(w => w.id === workerId);
            const data = generateWorkerData(workerId, dataIndex);
            const scrollbarWidth = getScrollbarWidth();
            
            // 스크롤바 너비만큼 padding 추가
            if (scrollbarWidth > 0) {
                document.body.style.paddingRight = scrollbarWidth + 'px';
            }
            
            document.getElementById('workerDetailName').textContent = worker.name + ' - ' + worker.role;
            
            const detailHtml = `
                <div class="mb-3">
                    <h6 class="text-muted mb-2">기본 정보</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">나이</small>
                                <div class="fw-bold">${worker.age}세</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">연락처</small>
                                <div class="fw-bold">${worker.phone}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">작업 구역</small>
                                <div class="fw-bold">${worker.zone}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">디바이스 ID</small>
                                <div class="fw-bold">${worker.deviceId}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-muted mb-2">현재 바이탈</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">심박수</small>
                                <div class="fw-bold ${data.heartRate > 100 ? 'text-danger' : 'text-success'}">
                                    ${data.heartRate} bpm
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">체온</small>
                                <div class="fw-bold ${data.temperature > 37.5 ? 'text-danger' : 'text-success'}">
                                    ${data.temperature}°C
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">가속도</small>
                                <div class="fw-bold">${data.acceleration}G</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">안정성</small>
                                <div class="fw-bold">${data.stability}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-muted mb-2">안전 상태</h6>
                    <div class="p-3 rounded" style="background: ${worker.status === 'danger' ? '#f8d7da' : worker.status === 'warning' ? '#fff3cd' : '#d1f4e0'}">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>낙상 위험도</span>
                            <span class="badge bg-${data.fallRisk === 'HIGH' ? 'danger' : data.fallRisk === 'MEDIUM' ? 'warning' : 'success'}">
                                ${data.fallRisk}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span>작업 시간</span>
                            <strong>${data.workHours} 시간</strong>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span>안전장비</span>
                            <div>
                                <i class="bi bi-check-circle-fill text-success me-1"></i>
                                <i class="bi bi-check-circle-fill text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary w-100" onclick="closeWorkerDetailModal()">
                    확인
                </button>
            `;
            
            document.getElementById('workerDetailBody').innerHTML = detailHtml;
            document.body.classList.add('modal-open');
            document.getElementById('workerDetailModal').classList.add('show');
        }

        /**
         * 작업자 상세 모달 닫기
         */
        function closeWorkerDetailModal() {
            document.body.style.paddingRight = '';
            document.body.classList.remove('modal-open');
            document.getElementById('workerDetailModal').classList.remove('show');
        }

        // ============================================
        // 긴급 알림 시스템
        // ============================================
        
        /**
         * 새로운 긴급 알림 추가 및 모달 자동 표시
         * @param {Object} alertData - 알림 데이터 { worker, workerId, type, message, icon, severity }
         * 
         * 사용 예시:
         * addEmergencyAlert({
         *     worker: '김철수',
         *     workerId: 1,
         *     type: 'critical',
         *     message: '낙상 감지! 즉시 확인 필요',
         *     icon: 'exclamation-circle-fill',
         *     severity: 'CRITICAL'
         * });
         */
        function addEmergencyAlert(alertData) {
            // 현재 시간 추가
            alertData.time = '방금';
            alertData.timestamp = Date.now();
            
            // 배열 맨 앞에 추가 (최신 알림이 위에 표시)
            emergencyAlerts.unshift(alertData);
            
            // 최대 50개까지만 보관
            if (emergencyAlerts.length > 50) {
                emergencyAlerts = emergencyAlerts.slice(0, 50);
            }
            
            // 일반 알림 목록도 업데이트
            generateAlerts();
            
            // 긴급 알림 모달 자동 표시
            openEmergencyModal();
        }

        /**
         * 긴급 알림 목록 렌더링
         */
        function renderEmergencyAlerts() {
            if (emergencyAlerts.length === 0) {
                document.getElementById('emergencyAlertList').innerHTML = 
                    '<p class="text-center text-muted">현재 긴급 알림이 없습니다.</p>';
                return;
            }

            const alertsHtml = emergencyAlerts.map(alert => `
                <div class="emergency-alert-item ${alert.type}" onclick="closeEmergencyModal(); openWorkerDetailModal(${alert.workerId})">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="severity-badge severity-${alert.type}">
                                ${alert.severity}
                            </span>
                        </div>
                        <small class="text-muted">${alert.time}</small>
                    </div>
                    <div>
                        <strong class="d-block mb-1">
                            <i class="bi bi-${alert.icon} me-2 text-danger"></i>${alert.worker}
                        </strong>
                        <div>${alert.message}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('emergencyAlertList').innerHTML = alertsHtml;
        }

        /**
         * 실시간 데이터 수신 시뮬레이션
         * 실제 환경에서는 WebSocket 또는 API polling으로 대체
         */
        function simulateRealtimeAlert() {
            // 데모: 30초마다 랜덤 알림 생성
            setInterval(() => {
                const randomWorker = workers[Math.floor(Math.random() * workers.length)];
                const alertTypes = [
                    { type: 'critical', message: '낙상 감지! 즉시 확인 필요', icon: 'exclamation-circle-fill', severity: 'CRITICAL' },
                    { type: 'warning', message: '위험구역 진입 감지', icon: 'geo-alt-fill', severity: 'WARNING' },
                    { type: 'critical', message: '심박수 이상 (130 bpm)', icon: 'heart-fill', severity: 'CRITICAL' },
                    { type: 'warning', message: '체온 상승 (37.8°C)', icon: 'thermometer-half', severity: 'WARNING' }
                ];
                const randomAlert = alertTypes[Math.floor(Math.random() * alertTypes.length)];
                
                // 30% 확률로 알림 생성
                if (Math.random() < 0.3) {
                    addEmergencyAlert({
                        worker: randomWorker.name,
                        workerId: randomWorker.id,
                        ...randomAlert
                    });
                }
            }, 30000); // 30초마다
        }

        // ============================================
        // 작업자 데이터 생성 및 관리
        // ============================================
        
        /**
         * 작업자별 센서 데이터 생성
         * @param {number} workerId - 작업자 ID
         * @param {number} time - 시간 인덱스
         * @returns {Object} 센서 데이터
         */
        function generateWorkerData(workerId, time) {
            const worker = workers.find(w => w.id === workerId);
            let baseHR = 75;
            let baseTemp = 36.8;
            let baseAccel = 1.0;
            let baseStability = 85;

            if (worker.status === 'warning') {
                baseHR = 105;
                baseTemp = 37.5;
                baseAccel = 2.5;
                baseStability = 65;
            } else if (worker.status === 'danger') {
                baseHR = 125;
                baseTemp = 38.2;
                baseAccel = 4.2;
                baseStability = 40;
            }

            return {
                heartRate: Math.floor(baseHR + Math.sin(time * 0.1) * 10 + Math.random() * 5),
                temperature: (baseTemp + Math.random() * 0.4).toFixed(1),
                acceleration: (baseAccel + Math.sin(time * 0.2) * 0.5 + Math.random() * 0.3).toFixed(2),
                stability: Math.floor(baseStability + Math.sin(time * 0.15) * 10 + Math.random() * 5),
                workHours: (5 + Math.random() * 3).toFixed(1),
                fallRisk: worker.status === 'danger' ? 'HIGH' : worker.status === 'warning' ? 'MEDIUM' : 'LOW'
            };
        }

        // ============================================
        // UI 렌더링 함수들
        // ============================================
        
        /**
         * 일반 알림 목록 생성
         */
        function generateAlerts() {
            // 긴급 알림 배열에서 최근 5개만 표시
            const recentAlerts = emergencyAlerts.slice(0, 5);
            
            if (recentAlerts.length === 0) {
                document.getElementById('alertsList').innerHTML = 
                    '<p class="text-center text-muted">현재 알림이 없습니다.</p>';
                return;
            }

            const alertsHtml = recentAlerts.map(alert => `
                <div class="alert-item ${alert.type}" onclick="openWorkerDetailModal(${alert.workerId})">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong class="d-block mb-1">
                                <i class="bi bi-${alert.icon} me-1"></i>${alert.worker}
                            </strong>
                            <div class="small">${alert.message}</div>
                        </div>
                        <small class="text-muted">${alert.time}</small>
                    </div>
                </div>
            `).join('');

            document.getElementById('alertsList').innerHTML = alertsHtml;
        }

        /**
         * 작업자 목록 렌더링
         */
        function renderWorkerList() {
            const html = workers.map(worker => `
                <div class="worker-card ${worker.status} ${worker.id === selectedWorkerId ? 'active' : ''}" 
                     onclick="selectWorker(${worker.id})">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong class="text-white">${worker.name}</strong>
                        <span class="status-badge status-${worker.status === 'normal' ? 'online' : worker.status}">
                            ${worker.status === 'danger' ? '위험' : worker.status === 'warning' ? '주의' : '정상'}
                        </span>
                    </div>
                    <div class="small text-secondary">${worker.role}</div>
                    <div class="small text-secondary">${worker.zone}</div>
                </div>
            `).join('');

            document.getElementById('workerList').innerHTML = html;
        }

        /**
         * 작업자 선택
         * @param {number} workerId - 선택한 작업자 ID
         */
        function selectWorker(workerId) {
            selectedWorkerId = workerId;
            renderWorkerList();
            // updateSelectedWorkerInfo();
            
            // 모바일에서 작업자 선택 시 사이드바 닫기
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        /**
         * 선택된 작업자 정보 업데이트
         */
        function updateSelectedWorkerInfo() {
            const worker = workers.find(w => w.id === selectedWorkerId);
            const data = generateWorkerData(selectedWorkerId, dataIndex);

            document.getElementById('selectedWorkerName').textContent = 
                `${worker.name} - ${worker.role}`;

            const statusBadge = worker.status === 'danger'
                ? '<span class="badge bg-danger">위험</span>'
                : worker.status === 'warning'
                ? '<span class="badge bg-warning text-dark">주의</span>'
                : '<span class="badge bg-success">정상</span>';

            document.getElementById('selectedWorkerStatus').innerHTML = statusBadge;

            const infoHtml = `
                <div class="row g-3">
                    <div class="col-md-3 col-6">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted d-block">작업 구역</small>
                            <strong class="d-block mt-1">${worker.zone}</strong>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted d-block">심박수</small>
                            <strong class="d-block mt-1 ${data.heartRate > 100 ? 'text-danger' : 'text-success'}">
                                ${data.heartRate} bpm
                            </strong>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted d-block">체온</small>
                            <strong class="d-block mt-1 ${data.temperature > 37.5 ? 'text-danger' : 'text-success'}">
                                ${data.temperature}°C
                            </strong>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted d-block">낙상 위험도</small>
                            <strong class="d-block mt-1 ${data.fallRisk === 'HIGH' ? 'text-danger' : data.fallRisk === 'MEDIUM' ? 'text-warning' : 'text-success'}">
                                ${data.fallRisk}
                            </strong>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted d-block">작업 시간</small>
                            <strong class="d-block mt-1">${data.workHours} 시간</strong>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted d-block">안전모</small>
                            <strong class="d-block mt-1 text-success">
                                <i class="bi bi-check-circle-fill"></i> 착용
                            </strong>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted d-block">안전벨트</small>
                            <strong class="d-block mt-1 text-success">
                                <i class="bi bi-check-circle-fill"></i> 착용
                            </strong>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('selectedWorkerInfo').innerHTML = infoHtml;
        }

        /**
         * 작업자 테이블 업데이트
         */
        function updateWorkerTable() {
            const html = workers.map(worker => {
                const data = generateWorkerData(worker.id, dataIndex);
                const statusClass = worker.status === 'danger' ? 'table-danger' 
                    : worker.status === 'warning' ? 'table-warning' : '';

                return `
                    <tr class="${statusClass}" onclick="selectWorker(${worker.id})" style="cursor: pointer;">
                        <td><strong>${worker.name}</strong></td>
                        <td>${worker.role}</td>
                        <td><span class="zone-badge">${worker.zone}</span></td>
                        <td>${data.heartRate} bpm</td>
                        <td>${data.temperature}°C</td>
                        <td>
                            <span class="badge bg-${data.fallRisk === 'HIGH' ? 'danger' : data.fallRisk === 'MEDIUM' ? 'warning' : 'success'}">
                                ${data.fallRisk}
                            </span>
                        </td>
                        <td>${data.workHours}h</td>
                        <td>
                            <i class="bi bi-check-circle-fill text-success" title="안전모"></i>
                            <i class="bi bi-check-circle-fill text-success ms-1" title="안전벨트"></i>
                        </td>
                        <td>
                            <span class="status-badge status-${worker.status === 'normal' ? 'online' : worker.status}">
                                ${worker.status === 'danger' ? '위험' : worker.status === 'warning' ? '주의' : '정상'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('workerTableBody').innerHTML = html;
        }

        /**
         * 낙상 이력 생성
         */
        function generateFallHistory() {
            const history = [
                { time: '14:32', worker: '정수진', location: 'C동 1층', accel: '4.8G', type: '전도', status: '대응중' },
                { time: '11:15', worker: '이영희', location: 'B동 옥상', accel: '3.2G', type: '미끄러짐', status: '완료' },
                { time: '09:47', worker: '정수진', location: 'C동 계단', accel: '2.9G', type: '넘어짐', status: '완료' }
            ];

            const html = history.map(h => `
                <tr>
                    <td>${h.time}</td>
                    <td><strong>${h.worker}</strong></td>
                    <td>${h.location}</td>
                    <td><span class="text-danger fw-bold">${h.accel}</span></td>
                    <td>${h.type}</td>
                    <td>
                        <span class="badge bg-${h.status === '대응중' ? 'warning' : 'success'}">
                            ${h.status}
                        </span>
                    </td>
                </tr>
            `).join('');

            document.getElementById('fallHistoryBody').innerHTML = html;
        }

        // ============================================
        // 차트 관련 함수
        // ============================================
        
        /**
         * 모든 차트 초기화
         */
        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                interaction: { mode: 'index', intersect: false }
            };

            // charts.acceleration = new Chart(document.getElementById('accelerationChart'), {
            //     type: 'line',
            //     data: {
            //         labels: chartData.labels,
            //         datasets: [{
            //             label: '가속도 (G)',
            //             data: chartData.acceleration,
            //             borderColor: '#dc3545',
            //             backgroundColor: 'rgba(220, 53, 69, 0.1)',
            //             fill: true,
            //             tension: 0.4,
            //             borderWidth: 2,
            //             pointRadius: 0
            //         }]
            //     },
            //     options: {
            //         ...commonOptions,
            //         plugins: { legend: { display: false } },
            //         scales: {
            //             y: { 
            //                 min: 0, 
            //                 max: 5,
            //                 ticks: {
            //                     callback: function(value) {
            //                         return value + 'G';
            //                     }
            //                 }
            //             }
            //         }
            //     }
            // });

            // charts.stability = new Chart(document.getElementById('stabilityChart'), {
            //     type: 'line',
            //     data: {
            //         labels: chartData.labels,
            //         datasets: [{
            //             label: '안정성 점수',
            //             data: chartData.stability,
            //             borderColor: '#0dcaf0',
            //             backgroundColor: 'rgba(13, 202, 240, 0.1)',
            //             fill: true,
            //             tension: 0.4,
            //             borderWidth: 2,
            //             pointRadius: 0
            //         }]
            //     },
            //     options: {
            //         ...commonOptions,
            //         plugins: { legend: { display: false } },
            //         scales: { y: { min: 0, max: 100 } }
            //     }
            // });

            // charts.heartRate = new Chart(document.getElementById('heartRateChart'), {
            //     type: 'line',
            //     data: {
            //         labels: chartData.labels,
            //         datasets: [{
            //             label: '심박수 (bpm)',
            //             data: chartData.heartRate,
            //             borderColor: '#fd7e14',
            //             backgroundColor: 'rgba(253, 126, 20, 0.1)',
            //             fill: true,
            //             tension: 0.4,
            //             borderWidth: 2,
            //             pointRadius: 0
            //         }]
            //     },
            //     options: {
            //         ...commonOptions,
            //         plugins: { legend: { display: false } },
            //         scales: { y: { min: 60, max: 140 } }
            //     }
            // });

            // charts.temperature = new Chart(document.getElementById('temperatureChart'), {
            //     type: 'line',
            //     data: {
            //         labels: chartData.labels,
            //         datasets: [{
            //             label: '체온 (°C)',
            //             data: chartData.temperature,
            //             borderColor: '#dc3545',
            //             backgroundColor: 'rgba(220, 53, 69, 0.1)',
            //             fill: true,
            //             tension: 0.4,
            //             borderWidth: 2,
            //             pointRadius: 0
            //         }]
            //     },
            //     options: {
            //         ...commonOptions,
            //         plugins: { legend: { display: false } },
            //         scales: { y: { min: 36, max: 39 } }
            //     }
            // });

            charts.fallZone = new Chart(document.getElementById('fallZoneChart'), {
                type: 'bar',
                data: {
                    labels: ['A동', 'B동', 'C동', '외부', '계단'],
                    datasets: [{
                        label: '낙상 발생 건수',
                        data: [5, 8, 12, 3, 7],
                        backgroundColor: ['#0d6efd', '#6610f2', '#d63384', '#fd7e14', '#dc3545']
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: { legend: { display: false } }
                }
            });

            const weeklyAccidents = [0, 0, 0, 0, 0]; // 최대 5주
            const ctx = document.getElementById("timeChart").getContext("2d");
            const weekColors = [
                "#007aff", // 1주
                "#34c759", // 2주
                "#ff9500", // 3주
                "#ff3b30", // 4주
                "#5856d6"  // 5주
            ];
            // [week][hour] → 사고 건수
            // week: 0~4 (1~5주)
            const weeklyHourlyAccidents = [
                [0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], // 1주
                [0,0,0,0,0,0,0,0,0,8,0,0,0,0,0,3,0,0,0,0,0,0,0,0], // 2주
                [0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0], // 3주
                [0,0,0,0,0,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0], // 4주
                [0,0,0,0,0,0,6,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0] // 5주
            ]

            charts.time = new Chart(ctx, {
                type: "line",
                data: {
                    labels: Array.from({ length: 24 }, (_, i) => `${i}시`),
                    datasets: weeklyHourlyAccidents.map((weekData, i) => ({
                        label: `${i + 1}주`,
                        data: weekData,
                        borderColor: weekColors[i],
                        borderWidth: 2,
                        tension: 0.35,
                        fill: false,
                        pointRadius: 2,
                        pointHoverRadius: 4
                        }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                    legend: {
                        position: "top"
                    },
                    tooltip: {
                        callbacks: {
                        label: ctx =>
                            `${ctx.dataset.label} · ${ctx.label}: ${ctx.parsed.y}건`
                        }
                    }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                            precision: 0
                            },
                            title: {
                            display: true,
                            text: "사고 발생 건수"
                            }
                        },
                        x: {
                            title: {
                            display: true,
                            text: "시간대"
                            }
                        }
                    }
                }
            });
        }

        /**
         * 실시간 데이터 업데이트
         */
        function updateData() {
            const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            const data = generateWorkerData(selectedWorkerId, dataIndex);

            chartData.labels.push(time);
            chartData.acceleration.push(parseFloat(data.acceleration));
            chartData.stability.push(data.stability);
            chartData.heartRate.push(data.heartRate);
            chartData.temperature.push(parseFloat(data.temperature));

            if (chartData.labels.length > maxDataPoints) {
                chartData.labels.shift();
                chartData.acceleration.shift();
                chartData.stability.shift();
                chartData.heartRate.shift();
                chartData.temperature.shift();
            }

            Object.keys(charts).forEach(key => {
                if (charts[key] && typeof charts[key].update === 'function') {
                    charts[key].update('none');
                }
            });

            // updateSelectedWorkerInfo();
            updateWorkerTable();

            dataIndex++;
        }

        // ============================================
        // 초기화 및 이벤트 리스너
        // ============================================
        
        /**
         * 페이지 로드 시 초기화
         */
        window.addEventListener('load', function() {
            // 날짜 표시
            const today = new Date();
            document.getElementById('currentDate').textContent = 
                today.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

            // 초기 차트 데이터 생성
            for (let i = 0; i < maxDataPoints; i++) {
                const time = new Date(Date.now() - (maxDataPoints - i) * 2000).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                const data = generateWorkerData(selectedWorkerId, i);

                chartData.labels.push(time);
                chartData.acceleration.push(parseFloat(data.acceleration));
                chartData.stability.push(data.stability);
                chartData.heartRate.push(data.heartRate);
                chartData.temperature.push(parseFloat(data.temperature));
            }

            dataIndex = maxDataPoints;

            // 초기 렌더링
            initCharts();
            renderWorkerList();
            generateAlerts();
            // updateSelectedWorkerInfo();
            updateWorkerTable();
            generateFallHistory();

            // 실시간 업데이트 시작 (2초마다)
            setInterval(updateData, 2000);
            
            // 실시간 알림 시뮬레이션 시작
            simulateRealtimeAlert();
            
            // 초기 샘플 알림 추가
            setTimeout(() => {
                addEmergencyAlert({
                    worker: '정수진',
                    workerId: 4,
                    type: 'critical',
                    message: '낙상 감지! 즉시 확인 필요',
                    icon: 'exclamation-circle-fill',
                    severity: 'CRITICAL'
                });
            }, 2000);
        });

        /**
         * 작업자 검색 기능
         */
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('workerSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const search = e.target.value.toLowerCase();
                    const cards = document.querySelectorAll('.worker-card');
                    
                    cards.forEach(card => {
                        const name = card.querySelector('strong').textContent.toLowerCase();
                        card.style.display = name.includes(search) ? 'block' : 'none';
                    });
                });
            }
        });
        
        /**
         * 모달 외부 클릭 시 닫기
         */
        document.getElementById('emergencyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmergencyModal();
            }
        });
        
        document.getElementById('workerDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeWorkerDetailModal();
            }
        });
    </script>
    <!-- SignalR CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/api")
            .withAutomaticReconnect()
            .build();

        connection.on("sensorUpdate", msg => {
            console.log("받음:", msg);

            var worker = workers.map(w => w.deviceId == msg.deviceId ? w.id : null)[0];
            console.log("deviceId:", msg.deviceId);
            console.log("workerId:", worker.id);

            addEmergencyAlert({
              worker: worker.name,
              workerId: worker.id,
              type: 'critical',
              message: msg.type,
              icon: 'exclamation-circle-fill',
              severity: 'CRITICAL'
            });
        });

        connection.start();
    </script>
</body>
</html>